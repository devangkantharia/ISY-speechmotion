<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!--Favicon-->
    <link rel="shortcut icon" href="images/favicon.ico" />
    <title>Babylon meets Leap Motion</title>
    <!-- Babylon.js -->

    <script src="js/babylon.js"></script>
    <script src="js/Oimo.js"></script>
    <script src="js/leap.js"></script>
    <script src="js/leap-plugins-0.1.11.js"></script>
    <script src="js/hand-1.3.7.js"></script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/annyang/2.4.0/annyang.min.js"></script>

    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>

</head>
<body>


<canvas id="renderCanvas"></canvas>
<script type="text/javascript">


    var leapX = 0;
    var leapY = 0;

    // Scene Creation
    var canvas = document.getElementById("renderCanvas");
    var engine = new BABYLON.Engine(canvas, true);
    var scene = new BABYLON.Scene(engine);

    //Physics

    var camera = new BABYLON.ArcRotateCamera("camera", Math.PI / 2, Math.PI / 2, 50, BABYLON.Vector3.Zero(), scene);
    scene.activeCamera = camera;
    camera.attachControl(canvas, true);
    camera.applyGravity = true;

	var light = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(1, 0, 1), scene);

	light.intensity = 0.8;

    // create some boxes
    var boxes = new Array();
    for (var x = 0; x <= 5; x += 4){
        for (var y = 0; y <= 5; y += 4){

            var box = BABYLON.Mesh.CreateBox("box" + x.toString() + y.toString(), 2, scene);
            box.position.y = y ;
            box.position.x = x ;
            box.position.z = Math.floor((Math.random() * 10) + 1);

            box.actionManager = new BABYLON.ActionManager(scene);

//            box.setPhysicsState(BABYLON.PhysicsEngine.BoxImpostor, { mass: 4 });

            box.isPickable = true;

            boxes.push(box);

        }
    }


    var leapBox =  BABYLON.Mesh.CreateBox("leapBox",1,scene);
    var leapMaterial = new BABYLON.StandardMaterial("leapMaterial", scene);
    leapMaterial.diffuseColor = new BABYLON.Color3(1.0, 0.2, 0.7);

    leapBox.material = leapMaterial;

    // --------------- annyang Functions --------------------------

    var addGround = function () {

        // Our built-in 'ground' shape. Params: name, width, depth, subdivs, scene
        var ground = BABYLON.Mesh.CreateGround("ground1", 42, 42, 2, scene);

        ground.position.y -= 14;
        ground.setPhysicsState(BABYLON.PhysicsEngine.BoxImpostor, { mass: 0 });

    };
    
    var removeGround = function () {
        // Our built-in 'ground' shape. Params: name, width, depth, subdivs, scene
        scene.getMeshByName("ground1").dispose();
    };
    
	var addBox = function () {
        // Our built-in 'ground' shape. Params: name, width, depth, subdivs, scene
        var box = BABYLON.Mesh.CreateBox("box",  3, scene);

        box.position.y = 15 - Math.floor((Math.random() * 30) + 1);
        box.position.x = 15 - Math.floor((Math.random() * 30) + 1);
        box.position.z = Math.floor((Math.random() * 10) + 1);
        box.setPhysicsState(BABYLON.PhysicsEngine.BoxImpostor, { mass: 4 });
        box.isPickable = true;


    };

    var addSphere = function () {
        // Our built-in 'ground' shape. Params: name, width, depth, subdivs, scene
        var sphere = BABYLON.Mesh.CreateSphere("sphere",  3, 3, scene);
        sphere.position.y = 15 - Math.floor((Math.random() * 30) + 1);
        sphere.position.x = 15 - Math.floor((Math.random() * 30) + 1);
        sphere.position.z = Math.floor((Math.random() * 10) + 1);
        sphere.setPhysicsState(BABYLON.PhysicsEngine.BoxImpostor, { mass: 4 });
        sphere.isPickable = true;


    };

    var randomPosBoxes = function () {
        // Our built-in 'ground' shape. Params: name, width, depth, subdivs, scene
        for (var x = 0; x <boxes.length; x++){
            boxes[x].position.z = Math.floor((Math.random() * 10) + 1);
        }
    };

    var physics = function () {
        scene.enablePhysics(new BABYLON.Vector3(0, -10, 0), new BABYLON.OimoJSPlugin());
    };


    // Resize
    window.addEventListener("resize", function () {
        engine.resize();

    });

	// -------- ANNYANG ------------
	if (annyang) {

        annyang.setLanguage("de-DE");
        // Let's define a command.
        var commands = {
            'Boden': addGround,
            'Entfernen' : removeGround,
            'Kugel' : addSphere,
            'Box' : addBox,
            'Physik' : physics,
            'Zufall' : randomPosBoxes
        };
        annyang.debug(true);
        // Add our commands to annyang
        annyang.addCommands(commands);


        // Start listening.
        annyang.start(true, true);
    }
    
    // ------------------------------

    var predicate = function(mesh) {

        return mesh.isPickable && mesh.isEnabled()

    }

    // Show some Debug Axis
    var showAxis = function(size) {
        var makeTextPlane = function(text, color, size) {
            var dynamicTexture = new BABYLON.DynamicTexture("DynamicTexture", 50, scene, true);
            dynamicTexture.hasAlpha = true;
            dynamicTexture.drawText(text, 5, 40, "bold 36px Arial", color , "transparent", true);
            var plane = new BABYLON.Mesh.CreatePlane("TextPlane", size, scene, true);
            plane.material = new BABYLON.StandardMaterial("TextPlaneMaterial", scene);
            plane.material.backFaceCulling = false;
            plane.material.specularColor = new BABYLON.Color3(0, 0, 0);
            plane.material.diffuseTexture = dynamicTexture;
            return plane;
        };

        var axisX = BABYLON.Mesh.CreateLines("axisX", [
            new BABYLON.Vector3.Zero(), new BABYLON.Vector3(size, 0, 0), new BABYLON.Vector3(size * 0.95, 0.05 * size, 0),
            new BABYLON.Vector3(size, 0, 0), new BABYLON.Vector3(size * 0.95, -0.05 * size, 0)
        ], scene);
        axisX.color = new BABYLON.Color3(1, 0, 0);
        var xChar = makeTextPlane("X", "red", size / 10);
        xChar.position = new BABYLON.Vector3(0.9 * size, -0.05 * size, 0);
        var axisY = BABYLON.Mesh.CreateLines("axisY", [
            new BABYLON.Vector3.Zero(), new BABYLON.Vector3(0, size, 0), new BABYLON.Vector3( -0.05 * size, size * 0.95, 0),
            new BABYLON.Vector3(0, size, 0), new BABYLON.Vector3( 0.05 * size, size * 0.95, 0)
        ], scene);
        axisY.color = new BABYLON.Color3(0, 1, 0);
        var yChar = makeTextPlane("Y", "green", size / 10);
        yChar.position = new BABYLON.Vector3(0, 0.9 * size, -0.05 * size);
        var axisZ = BABYLON.Mesh.CreateLines("axisZ", [
            new BABYLON.Vector3.Zero(), new BABYLON.Vector3(0, 0, size), new BABYLON.Vector3( 0 , -0.05 * size, size * 0.95),
            new BABYLON.Vector3(0, 0, size), new BABYLON.Vector3( 0, 0.05 * size, size * 0.95)
        ], scene);
        axisZ.color = new BABYLON.Color3(0, 0, 1);
        var zChar = makeTextPlane("Z", "blue", size / 10);
        zChar.position = new BABYLON.Vector3(0, 0.05 * size, 0.9 * size);
    };

    showAxis(10)

    // Show Debug Ray for Leap Position
    var debugRay = BABYLON.Mesh.CreateLines("debugRay", [
        new BABYLON.Vector3(0, 0, 0),
        new BABYLON.Vector3(0, 0, 100),

    ], scene);

    // Render Loop + Leap Loop
    engine.runRenderLoop(function () {
            Leap.loop(function(frame) {

                if(frame.hands.length > 0)
                {

                    var hand = frame.hands[0];
                    var position = hand.palmPosition;
                    var velocity = hand.palmVelocity;
                    var direction = hand.direction;

                    var index = hand.indexFinger;

                    var interactionBox = frame.interactionBox;
                    var normalized = interactionBox.normalizePoint(position,true);

                    var canvasX = 50 * (normalized[0] - 1);
                    var canvasY  = 50 * (1 - (normalized[1] - 1));

                    leapY = (-1) * hand.screenPosition()[1] / 50;
                    leapX = (-1) * hand.screenPosition()[0] / 50 + 16;


                    debugRay.position.x = leapX;
                    debugRay.position.y = leapY;

                    var origin = new BABYLON.Vector3(0,0,100)
                    var pos = new BABYLON.Vector3(leapX,leapY,0);

                    var dir = pos.subtract(origin).normalize();

                    var ray = new BABYLON.Ray(debugRay.position, new BABYLON.Vector3(0, 0, 1),200);

                    var mesh = scene.pickWithRay(ray);

                    if (mesh.pickedMesh != null){

                        // Highlight selected Mesh
                        mesh.pickedMesh.outlineWidth = 0.3;
                        mesh.pickedMesh.renderOutline = true;

                       // Rotate selected Mesh by handy rotation
                        mesh.pickedMesh.rotation.y = direction[1] * Math.PI;
                        mesh.pickedMesh.rotation.x = direction[0]* Math.PI;
                        mesh.pickedMesh.rotation.z = direction[2]* Math.PI;

                        // Hand closed >> Move selected mesh
                        if(hand.grabStrength == 1){
                            mesh.pickedMesh.position.x = leapX;
                            mesh.pickedMesh.position.y = leapY;
                        }
                    }

                   //  console.log("x:  "+ canvasX + "  y:  "+ canvasY +"  z:  ");

                }


        }).use('screenPosition', {scale: 1});
        
        scene.render();

    });

</script>
</body>
</html>