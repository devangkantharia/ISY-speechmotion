<!DOCTYPE html>
<html lang="en">
<head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <!--Favicon-->
    <link rel="shortcut icon" href="images/favicon.ico" />

    <title>Speechmotion 3D | Dokumentation Bildbearbeitung</title>


    <!-- Stylesheets -->
    <link rel="stylesheet" type="text/css" href="css/styleDoku.css" media="screen" />
    <link rel="stylesheet" type="text/css" href="css/leapstrap.css" media="screen" />
    <link rel="stylesheet" src="css/bootstrap.css"/>
    <link rel="stylesheet" href="css/font-awesome.css"/>
    <!--JavaScript -->
    <script src="js/babylon.js"></script>
    <script src="js/leap.js"></script>
    <script src="js/speechmotion.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/leapstrap.js"></script>
    <!-- FOr touch events. olyfill library https://github.com/deltakosh/handjs/blob/master/bin/hand.js -->
    <script src="js/hand.js"></script>
    <script src="js/leap-plugins-0.1.11.js"></script>
    <script src="js/annyang.min.js"></script>
    <script src="js/hand.js"></script>

    </head>
    <body>
    <nav  class="navbar mynav navbar-fixed-top " role="navigation" style="background-color:white;">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle leap-interactive" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                </button>

                <!--   <span class="icon-bar"></span> </button> <a class="navbar-brand leap-interactive" href="#">Speechmotion 3D</a> -->
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
                <li><a class="navbar-brand leap-interactive" rel="home" href="#" title="Bildbearbeitung">
                    Speechmotion / Bildbearbeitung
                </a></li>
            </ul>


        </div>
    <!-- /.navbar-collapse -->
</nav>

    <nav  class="navbar mynav navbar-fixed-top " role="navigation" style="margin-top: 40px;">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle leap-interactive" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1"> <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                </button>
            <a class="navbar-brand" href="./index.html"></a>
                <!--   <span class="icon-bar"></span> </button> <a class="navbar-brand leap-interactive" href="#">Speechmotion 3D</a> -->
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="nav2">
            <ul class="nav navbar-nav">

                <li><a class="leap-interactive" href="#help">Anleitung</a></li>
                <li><a class="leap-interactive" href="#doku">Dokumentation</a></li>
                <li><a target="_blank" class="leap-interactive" href="./speechmotion.html">Demo</a></li>
            </ul>


        </div>
        <!-- /.navbar-collapse -->
    </nav>

<section style="background-color:#3e3e3e;" >

    <div style="padding:70px; padding-bottom: 10px">
        <div class="page-header"id="help">
            <h1>Bildbearbeitung <small class="dimgray">mit Leap Motion, BabylonJS und Annyang</small></h1>
        </div>

        <div class="jumbotron" style="background-color: white; padding-top: 10px;">
            <h1 style="font-size: 46px;">Anleitung</h1>

        <p>
        Folgende Befehle können ausgeführt werden:
        </br>
        <small><i class="fa fa-sign-language" aria-hidden="true"></i> = Leap Motion</small>
        </br>
        <small><i class="fa fa-comment" aria-hidden="true"></i> = Sprachbefehle</small>
        </p>
        <p><strong>Interaktion</strong></p>
            <ul>
                <li>Auswahl eines Bildes:<ul><li><i class="fa fa-sign-language" aria-hidden="true"></i> Mit dem rechten Zeigefiner ca. 1 Sekunde auf das Bild zeigen. </li></ul> </li>
                <li>Bild drehen und skalieren: <ol><li><i class="fa fa-comment" aria-hidden="true"></i> Sag "drehen und skalieren", nachdem ein Bild ausgewählt wurde.</li><li><i class="fa fa-sign-language" aria-hidden="true"></i> Rotiere die rechte Hand um das Bild zu rotieren </li></ol> </li>
                <li>Bild verschieben: <ol><li><i class="fa fa-comment" aria-hidden="true"></i> Sag "verschieben", nachdem ein Bild ausgewählt wurde</li><li><i class="fa fa-sign-language" aria-hidden="true"></i> Verschiebe das Bild mit Hilfe des rechten Zeigefingers</li></ol> </li>
                <li>Bild abwählen: <ul><li><i class="fa fa-comment" aria-hidden="true"></i> Sag "okay", nachdem ein Bild ausgewählt wurde</li></ul> </li>
                <li>Untergrund und Bildersockel <ul><li><i class="fa fa-comment" aria-hidden="true"></i> Sag "Boden", nachdem ein Bild ausgewählt wurde um einen Boden und 4 Sockel anzuzeigen sowie eine Information zur Kollision-Erkennung</li></ul> </li>
                <li>Untergrund und Bildersockel entfernen<ul><li><i class="fa fa-comment" aria-hidden="true"></i> Sag "entfernen" um den Boden und die Bildersockel zu entfernen</li></ul> </li>




            </ul>
            </br>
            <p><strong>Bildbearbeitung</strong></p>
            <p><small>Zur Bildbearbeitung muss ein Bild ausgewählt sein und je nach vorheriger Interaktion: <i class="fa fa-comment" aria-hidden="true"></i> sage "editieren"</small></p>
            <ul>
                <li>Graustufen<ul><li><i class="fa fa-sign-language" aria-hidden="true"></i> Zeige mit dem rechten Zeigefinger ca. 1 Sek auf den Button "Graustufen" </li><li><i class="fa fa-comment" aria-hidden="true"></i> Sage "Graustufen" </li></ul> </li>
                <li>Invertieren<ul><li><i class="fa fa-sign-language" aria-hidden="true"></i> Zeige mit dem rechten Zeigefinger ca. 1 Sek auf den Button "Invertieren" </li><li><i class="fa fa-comment" aria-hidden="true"></i> Sage "Invertieren" </li></ul> </li>
                <li>Blaufilter<ul><li><i class="fa fa-sign-language" aria-hidden="true"></i> Zeige mit dem rechten Zeigefinger ca. 1 Sek auf den Button "Blaufilter" </li><li><i class="fa fa-comment" aria-hidden="true"></i> Sage "Blaufilter" </li></ul> </li>
                <li>Helligkeit erhöhen<ul><li><i class="fa fa-sign-language" aria-hidden="true"></i> Zeige mit dem rechten Zeigefinger ca. 1 Sek auf den Button "+" rechts neben dem Slider für Helligkeit </li><li><i class="fa fa-comment" aria-hidden="true"></i> Sage "heller" </li></ul> </li>
                <li>Helligkeit reduzieren<ul><li><i class="fa fa-sign-language" aria-hidden="true"></i> Zeige mit dem rechten Zeigefinger ca. 1 Sek auf den Button "-" links neben dem Slider für Helligkeit </li><li><i class="fa fa-comment" aria-hidden="true"></i> Sage "dunkel" [dunkler wurde nicht gut von Annyang erkannt] </li></ul> </li>
                <li>Kontrast erhöhen<ul><li><i class="fa fa-sign-language" aria-hidden="true"></i> Zeige mit dem rechten Zeigefinger ca. 1 Sek auf den Button "+" rechts neben dem Slider für Kontrast  </li><li><i class="fa fa-comment" aria-hidden="true"></i> Sage "Kontrast erhöhen" </li></ul> </li>
                <li>Kontrast reduzieren<ul><li><i class="fa fa-sign-language" aria-hidden="true"></i> Zeige mit dem rechten Zeigefinger ca. 1 Sek auf den Button "-" rechts neben dem Slider für Kontrast  </li><li><i class="fa fa-comment" aria-hidden="true"></i> Sage "Kontrast reduzieren" </li></ul> </li>
                <li>Bilder wechseln<ul><li><i class="fa fa-sign-language" aria-hidden="true"></i> Male mit dem Zeigefinger, an einer Stelle, kleine Kreise in die Luft </li><li><i class="fa fa-comment" aria-hidden="true"></i> Sage "Bild wechseln" </li></ul> </li>
                <li>Zurücksetzen<ul><li><i class="fa fa-sign-language" aria-hidden="true"></i> Zeige mit dem rechten Zeigefinger ca. 1 Sek auf den Button "Zurücksetzen"  </li><li><i class="fa fa-comment" aria-hidden="true"></i> Sage "Zurücksetzen" </li></ul> </li>
                <li>Speichern<ul><li><i class="fa fa-comment" aria-hidden="true"></i> Lade das aktuelle Bild herunter indem du "Speichern" sagst. </li></ul> </li>


            </ul>


        </div>
    </div>
</section>



<section style="background-color:black;" id="doku">
    <div style="padding:70px;">
        <div class="jumbotron" style="background-color: white; padding-top: 10px;">
            <h1 style="font-size: 46px;">Dokumentation</h1>
            <p><strong>BabylonJS Canvas Elemente</strong></p>
            <p><small>Erstellung von Elementen mit BabylonJS im 3D Canvas</small></p>
            <p>Nachdem die üblichen Babylon-Konfigurationen (Kamera, Licht, etc.) gesetzt wurden, werden die einzelnen Elemente des Canvas aufgebaut. In dieser Szene sind das in erster Linie die Bilder und die Buttons/Slider zur Bildbearbeitung.
            Die Bilder werden in einer Schleife gesetzt. Zuerst wird eine Textur erzeugt mit einem Bild, diese Textur wird dann einem Mesh (Plane) zugeordnet.
        </p>
            <p>

<pre><code>var index = 1;
var gallery = new Array();
for (var x = 500; x <= 850; x += 200) {
for (var y = -400; y <= -100; y += 200) {
//Babylon Material/Textur erstellen und das Bild als Textur setzen
var materialPlane = new BABYLON.StandardMaterial("texturePlane" + index, scene);
materialPlane.diffuseTexture = new BABYLON.Texture("gallery/img" + index + ".jpg", scene);
materialPlane.specularColor = new BABYLON.Color3(0, 0, 0);
//Zeige eine Vorder-und Rückseite
materialPlane.backFaceCulling = false;

//Erstelle für den Slider eine Plane welches das oben angegebene Material als Textur hat und folgende Koordinaten und Größe
var plane = BABYLON.Mesh.CreatePlane("image" + index, 120, scene);
plane.material = materialPlane;
plane.position.y = y;
plane.position.x = -x;
plane.position.z = 0;
plane.isPickable = true;
gallery.push(plane);
index++;

}
}
            </code></pre></p>
            <p>Ergebnis:</p>
            <p>Ähnlich werden auch die Buttons und Slider, also die GUI für die Bildbearbeitung erstellt. Ebenfalls mit Babylon-Planes.</p>
            <p>

<pre><code>//Babylon Material wird erstellt um eine Textur zu erstellen
var sliderMateriaContrast = new BABYLON.StandardMaterial("texturePlane" + index, scene);
sliderMateriaContrast.specularColor = new BABYLON.Color3(0, 0, 0);
//Zeige eine Vorder-und Rückseite
sliderMateriaContrast.backFaceCulling = false;

//Erstelle für den Slider eine Plane welches das oben angegebene Material als Textur hat und folgende Koordinaten und Größe
var sliderContrast = BABYLON.Mesh.CreatePlane("sliderContrast" , 10, scene);
sliderContrast.material = sliderMateriaContrast;
sliderContrast.scaling.x= 30;
sliderContrast.position.y = canvas.height/2.80;
sliderContrast.position.x = -640;
sliderContrast.position.z = 0;
sliderContrast.isPickable = true;
</code></pre>
            </p>
            <p>Ergebnis:</p>

            </br><p><strong>Leap Motion</strong></p>

            <p><small>Interaktion durch Gestenerkennung</small></p>
            <p>Im Leap loop werden mittels Switch-cases die momentan möglichen Interaktionsmöglichkeiten eingegrenzt. Dies ist besonders
            sinnvoll, da die Leap Motion Sensoren sehr sensibel sind und jede noch so kleine Bewegung wahrnehmen können, sodass Gesten und Bewegungen
            nicht selten nicht klar voneinander unterschieden werden können.
            Bei Spielanfang ist der erste Case 1 gesetzt, das bedeutet per Leap kann man nur eine Interaktion machen und diese ist: auswählen. Der Nutzer soll
            also ein Bild auswählen. Wie geschieht dies?</p>
            <p>Der rechte Zeigefinger (man kann jeden ausgesterckten Finger der rechten Hand nehmen, aber mit dem Zeigefinger ist es am einfachsten) wird als Cursor mit der Leap Motion getrackt und die aktuelle Position des rechten Zeigefingers in der Leap Motion Interaktionsbox
            wird einem 2D HTML Element, einem kleinen Kreis, zugeordnet.</p>


<pre><code>//Wenn ein Finger der rechten Hand erkannt wurde
if (frame.pointables.length > 0 && frame.hands[0].type === "right") {
//Die stabiliserte Position des Fingers, d.h. das z.B. das normale unmerkliche Zittern der Hand nicht in die Berechnung einfließt
var positionLeap = frame.pointables[0].stabilizedTipPosition;
//Normalized = normalisierte Koordinaten der Fingerposition innerhalb der Interaktionsbox, welche eine Kastenförmige Region innerhalb des Leap-Motion Sichtfeldes ist
var normalized = frame.interactionBox.normalizePoint(positionLeap);
//complete hand tracking data of current frame
var hand = frame.hands[0];

//Cursor-Position wird aktualisiert mit den x und y Werten der normalisierten Position der Leap
cursor.style.left = (canvas.width * normalized[0]) + 'px';
cursor.style.top = (canvas.height * (1 - normalized[1] )) + 'px';</code></pre>
<p>Man kann die Position des Cursor auch anders umrechnen und zwar so wie es beim Laden der Szene mittels der Methode Project gemacht wird: </p>
<pre><code>//Project-Methode wurde im "Learning Babylon.js" Buch von Julian Chenard gefunden
//folgende Funktion erstellt die Transformationsmatrix der Szene. Ohne dieses Kommando läuft der Rest nicht
scene.updateTransformMatrix();
//3D Position
var _3Dposition = new BABYLON.Vector3(1, 1, 1);
//Project Methode um 3D Positionen (3D Vektor) in eine 2D Position umzuwandeln
    var _2Dposition = BABYLON.Vector3.Project(
        _3Dposition,
        BABYLON.Matrix.Identity(),   //world matrix
        scene.getTransformMatrix(), //transformation matrix
        scene.activeCamera.viewport.toGlobal(engine) //viewport
    );
    //Mit der _2Dposition wird nun die Position des Cursors gesetzt
    cursor.style.left = _2Dposition.x + 'px';
    cursor.style.top = _2Dposition.y + 'px';</code></pre>
<p>Bei jedem Frame wird der Bewegungsvektor zwischen dem Frame vor 30 Frames und dem jetzigen Frame verglichen.</p>

<pre><code>//der Frame vor 30 Frame (Klick-Event wird ausgelöst, wenn der Finger für 30 Frames ungefähr an der gleichen Stelle ist)
var tenFramesBack = controller.frame(30);
//der Bewegungsvektor zwischen dem Frame vor 30 Frames und dem jetzigen Frame
 var movement = hand.translation(tenFramesBack);</code></pre>
<p>Sollte der Finger auf ungefähr der gleichen Stelle geblieben sein (Bewegung unter 1) dann wird ein Klick-Event ausglöst </p>

 <pre><code>//Ein Klick-Event wird simuliert mit scene.pick und den 2D Koordinaten des Cusrsor
var pickResult = scene.pick(rect.left, rect.top);</code></pre>
            <p>Wenn sich an der Stelle auf die geklickt wird ein Bild befindet wird dieses ausgewählt, dass bedeutet als momentan selektiertes Mesh gesetzt
            und in vergrößerter Darstellung auf dem Bildschirm angezeigt.</p>
            <p> Nachdem ein Bild ausgewählt wurde kann man kein weiteres Bild mehr auswählen bis der Nutzer mit dem Sprachbefehl "okay" das Bild wieder abgewählt hat.
            </p>
            <p>Nachdem das Bild ausgewählt wurde wird automatisch in den Editiermodus gewechselt, man kann nun also die Sprachbefehle zu Bildbearbeitung geben oder
            das Bild drehen/bewegen mit den entsprechenden Befehlen. </p>
            <p>Neben den Sprachbefehlen kann man die Bildbearbeitung auch mit Gesten ausführen.
            Die Interaktion mit den Button funktioniert nach dem gleichen Muster wie bei der Auswahl des Bildes.</p>
            <p>Nachdem ein Bild selektiert wurde wird das aktuelle Bild, also die Textur des aktuell ausgwählten Mesh, in einem 2D Canvas auf der Seite geschrieben.
            </p><p>Bei Befehlen die das Bild verändernden, wie zum Beispiel Graustufen wird dann folgenderweise vorgegangen:</p>
<pre><code>var grayscale = function () {
 //wenn ein Bild ausgewählt ist
 if (currentPickedMesh) {
var canni = document.getElementById('imgcanvas');
var ctx = canni.getContext('2d');
//Die Bildaten des aktuellen Bildes auf dem 2D Canvas
var imageData = ctx.getImageData(0, 0, canni.width, canni.height);
var data = imageData.data;
//Pixel Manipulationen
for (var i = 0; i < data.length; i += 4) {
var avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
data[i] = avg;
data[i + 1] = avg;
data[i + 2] = avg;}
ctx.putImageData(imageData, 0, 0);
var dataURL = canni.toDataURL("image/jpg");
//unbedingt notwendig, sonst akzeptiert CreateFromBase64String die Daten nicht
dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
//Es wird eine neue Textur erstellt welche dann dem momentan ausgewählten Mesh zugewiesen wird.
var materialPlane = new BABYLON.StandardMaterial("texturePlane", scene);
//CreateFromBase64String = Die dort anzugebenen Daten sind schlecht dokumentiert und nur auf die hier angegebene Art und Weise zu erstellem
materialPlane.diffuseTexture = new BABYLON.Texture.CreateFromBase64String(dataURL, "newimageGrayScale", scene);
</code></pre>
<p>Man kann das ausgewählte Bild auch bewegen (Sprachbefehl: Verschieben). Dies macht besonders Sinn wenn man vorher "Boden" gesagt hat und dann versucht das Bild auf einem
der Sockel zu platzieren. Sobald das Bild den Sockel berührt wird dies über die Analyse-Box auf der linken Seite angezeigt. Sagt man dann "Okay" kann man das nächste Bild auswählen und mit verschieben platzieren.</p>
<p>Man kann verschiedene Ansätze nutzen um Bewegungen welche mit der Leap Motion getrackt werden auf die Babylon 3D Szene zu übertragen.
In diesem Beispiel haben wir folgende benutzt (in anderen Beispielen aber andere Ansätze).</p>
<pre><code>//über die screenPosition des Hand Objekts eines Frames werden die x, y und z Werte angegeben
leapX = (-1) * hand.screenPosition()[0];
leapY = (-1) * hand.screenPosition()[1];
leapZ = hand.screenPosition()[2];
//x, y und z Werte werden multipliziert für einen an die Szene angepassten Bewegungsrahmen
currentPickedMesh.position.x =leapX*2;
currentPickedMesh.position.y =leapY*2;
currentPickedMesh.position.z =leapZ*3;
</code></pre>
<p>Das Bild kann rotiert werden und zwar indem man, nachdem man ein Bild ausgewählt hat, "drehen und skalieren" sagt und dann die rechte Hand dreht.
    Die Drehung der rechten Hand wird auf die Drehung des Bildes übertragen. Die Drehung der Hand erhält man über die Leap Motion mit den Funktionen
    <ul>
            <li>frame.hands[0].roll(); = Rotation um die X-Achse</li>
            <li>frame.hands[0].pitch(); = Rotation um die Y-Achse</li>
            <li>frame.hands[0].yaw(); = Rotation um die Z-Achse</li>
        </ul>
            <p>Diese Drehungen können dann auf die Rotation des Babylon-Mesh übertragen werden. </p>
            <p>Das Bild skalieren kann man auch mit dem Befehl "drehen und skalieren" und zwar am besten indem man die linke Hand über dem Leap Motion Gerät hoch und runter bewegt.
            Es wird für die Skalierung die Veränderung der Handposition genommen, verändert sich die Position schnell nach oben wird das Bild um einen größeren Wert vergrößert,
            wenn sich die Hand nach unten bewegt, dann wird das Bild verkleinert, im Zusammenhang mit der Geschwindigkeit der Bewegung nach unten.</p>
            <pre><code>var handNormPosition = frame.interactionBox.normalizePoint(frame.hands[1].palmPosition, true);
var velHand = frame.hands[1].palmVelocity;
if (velHand[1] < 0) {
//Übertragung der palmVelocity auf die x und y Größe des ausgewählten Meshs.
currentPickedMesh.scaling.x = handNormPosition[1] * 10;
currentPickedMesh.scaling.y = handNormPosition[1] * 10;
} else {currentPickedMesh.scaling.x = handNormPosition[1] * 10;
currentPickedMesh.scaling.y = handNormPosition[1] * 10;}</code></pre>
</br>
            <p><strong>Annyang</strong></p>
            <p><small>Sprachsteuerung</small></p>
            <p>Annyang ist sehr einfach zu nutzen. Wichtig zu wissen bei Annyang ist (was wir nur durch Testen mit einhergehender Verzweiflung herausfanden)
            </p>
            <p><strong>Annyang kann nur in einem Tab genutzt werden!</strong> Wird Annyang in mehreren Tabs verwendet funktioniert die Spracherkennung nicht.</p>
            <p><strong>Annyang kann nicht im aktuellen Firefox oder Edge verwendet werden.</strong> Im aktuellen Chrome hingegen funktioniert Annyang.</p>
            <p><strong>Annyang stürzt manchmal ab.</strong> Meist ohne ersichtlichen Grund und nur durch Neustart der Seite behebbar.</p>
            <p>Des weiteren ist darauf zu achten, dass es nicht zuviele Hintergrundgeräusche gibt.</p>
            <p>Wenn Annyang denn dann funktioniert, dann werden die vorher festgelegten Befehle sehr gut erkannt.</p>
            <p>


<pre><code>//Wenn Annyang mit dem Browser kompatibel ist
if (annyang) {
// Sprachbefehle und die damit aufzurufenden Funktionen
var commands = {
'Boden': addGround,
'verschieben': move,
'Graustufen': grayscale,
'Invertieren': invert,
[...]
annyang.addCommands(commands);
//language = german
annyang.setLanguage("de-DE");
annyang.start(true, true);}
else{console.log("Annyang ist mit diesem Browser nicht kompatibel.")}</code></pre></p>
        </div>

    </div>

</section>





<!-- Init Leap, Set all "a" interactive, use 1 Leap cursor/finger -->
<script>LeapManager.init({interactiveSelector:"a",maxCursors:1});</script>

</body>
</html>